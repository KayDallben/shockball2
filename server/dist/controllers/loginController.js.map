{"version":3,"sources":["../../src/controllers/loginController.js"],"names":["swcApi","LoginController","db","logger","tokens","collection","req","res","validation","validate","query","listOneParams","error","getAccessToken","authorization_code","tokenInfo","expiresAtMinutes","data","expires_in","add","access_token","refresh_token","expires_at","dateWithAddedMinutes","created_at","Date","newToken","doc","id","update","uid","safeTokenInfo","status","send","minutes","getTime"],"mappings":";;;;;;qjBAAA;;;AAGA;;;AAFA;;;;AAGA;;IAAYA,M;;AACZ;;;;;;;;;;;;IAEMC,e;AAEJ,2BAAYC,EAAZ,EAAgBC,MAAhB,EAAwB;AAAA;;AACtB,SAAKC,MAAL,GAAcF,GAAGG,UAAH,CAAc,QAAd,CAAd;AACA,SAAKF,MAAL,GAAcA,MAAd;AACD;;;;;0FAEaG,G,EAAKC,G;;;;;;AACXC,0B,GAAa,cAAIC,QAAJ,CAAaH,IAAII,KAAjB,EAAwB,gBAAYC,aAApC,C;;sBACfH,WAAWI,KAAX,KAAqB,I;;;;;;;uBAEGZ,OAAOa,cAAP,CAAsBP,IAAII,KAAJ,CAAUI,kBAAhC,C;;;AAAlBC,yB;AACAC,gC,GAAoB,CAACD,UAAUE,IAAV,CAAeC,UAAf,GAA4B,GAA7B,IAAoC,E;;uBACvC,KAAKd,MAAL,CAAYe,GAAZ,CAAgB;AACrCC,gCAAcL,UAAUE,IAAV,CAAeG,YADQ;AAErCC,iCAAeN,UAAUE,IAAV,CAAeI,aAFO;AAGrCC,8BAAY,KAAKC,oBAAL,CAA0BP,gBAA1B,CAHyB;AAIrCQ,8BAAY,IAAIC,IAAJ;AAJyB,iBAAhB,C;;;AAAjBC,wB;;uBAMA,KAAKtB,MAAL,CAAYuB,GAAZ,CAAgBD,SAASE,EAAzB,EAA6BC,MAA7B,CAAoC;AACxCC,uBAAKJ,SAASE;AAD0B,iBAApC,C;;;AAGAG,6B,GAAgB;AACpBX,gCAAcL,UAAUE,IAAV,CAAeG,YADT;AAEpBE,8BAAY,KAAKC,oBAAL,CAA0BP,gBAA1B;AAFQ,iB;;AAItBT,oBAAIyB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBF,aAArB;;;;;;;;AAEA,qBAAK5B,MAAL,CAAYS,KAAZ;AACAL,oBAAIyB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,uCAArB;;;;;;;AAGF,qBAAK9B,MAAL,CAAYS,KAAZ,CAAkB,2BAA2BJ,WAAWI,KAAxD;AACAL,oBAAIyB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBzB,WAAWI,KAAhC;;;;;;;;;;;;;;;;;;yCAIiBsB,O,EAAS;AAC5B,aAAO,IAAIT,IAAJ,CAAS,IAAIA,IAAJ,GAAWU,OAAX,KAAwBD,UAAU,KAA3C,CAAP;AACD;;;;;;kBAIYjC,e","file":"loginController.js","sourcesContent":["//third party\r\nimport Joi from 'joi'\r\n\r\n//internal\r\nimport * as swcApi from '../lib/swcApi'\r\nimport LoginSchema from '../models/Login.js'\r\n\r\nclass LoginController {\r\n\r\n  constructor(db, logger) {\r\n    this.tokens = db.collection('tokens')\r\n    this.logger = logger\r\n  }\r\n\r\n  async listOne(req, res) {\r\n    const validation = Joi.validate(req.query, LoginSchema.listOneParams)\r\n    if (validation.error === null) {\r\n      try {\r\n        const tokenInfo = await swcApi.getAccessToken(req.query.authorization_code)\r\n        const expiresAtMinutes = ((tokenInfo.data.expires_in - 120) / 60 )\r\n        const newToken = await this.tokens.add({\r\n          access_token: tokenInfo.data.access_token,\r\n          refresh_token: tokenInfo.data.refresh_token,\r\n          expires_at: this.dateWithAddedMinutes(expiresAtMinutes),\r\n          created_at: new Date()\r\n        })\r\n        await this.tokens.doc(newToken.id).update({\r\n          uid: newToken.id\r\n        })\r\n        const safeTokenInfo = {\r\n          access_token: tokenInfo.data.access_token,\r\n          expires_at: this.dateWithAddedMinutes(expiresAtMinutes)\r\n        }\r\n        res.status(200).send(safeTokenInfo)\r\n      } catch(error) {\r\n        this.logger.error(error)\r\n        res.status(400).send('Error creating new player in database')\r\n      }\r\n    } else {\r\n      this.logger.error('Joi validation error: ' + validation.error)\r\n      res.status(400).send(validation.error)\r\n    }\r\n  }\r\n\r\n  dateWithAddedMinutes(minutes) {\r\n    return new Date(new Date().getTime() + (minutes * 60000))\r\n  }\r\n\r\n}\r\n\r\nexport default LoginController"]}
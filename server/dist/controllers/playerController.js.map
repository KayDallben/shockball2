{"version":3,"sources":["../../src/controllers/playerController.js"],"names":["util","PlayerController","db","logger","players","collection","teams","events","contracts","req","res","validation","validate","params","listParams","Object","keys","query","length","constructor","error","get","then","snapshot","forEach","doc","push","data","status","send","name","message","searchValidation","listSearchParams","where","queryProp","queryVal","id","updateParams","updateSet","regimen","JSON","parse","update","_writeTime","doc2","errorMessage","listOneParams","playerData","teamData","contractData","records","teamUid","contractUid","doc3","shockballPlayerUid","doc4","generateSummaryRecords","season","matches","goals","shots","passes","blocksPass","blocksShot","tackles","runsBall","goalAverage"],"mappings":"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","file":"playerController.js","sourcesContent":["//third party\r\nimport Joi from 'joi'\r\n\r\n//internal\r\nimport PlayerSchema from '../models/Player.js'\r\nimport * as util from '../lib/util.js'\r\n\r\nclass PlayerController {\r\n\r\n  constructor(db, logger) {\r\n    this.players = db.collection('players')\r\n    this.teams = db.collection('teams')\r\n    this.events = db.collection('events')\r\n    this.contracts = db.collection('contracts')\r\n    this.logger = logger\r\n  }\r\n\r\n  async list(req, res) {\r\n    const validation = Joi.validate(req.params, PlayerSchema.listParams)\r\n    if (Object.keys(req.query).length === 0 && req.query.constructor === Object) {\r\n      if (validation.error === null) {\r\n        try {\r\n          await this.players.get().then((snapshot) => {\r\n            let players = []\r\n            snapshot.forEach((doc) => {\r\n              players.push(doc.data())\r\n            })\r\n            if (players.length > -1) {\r\n              res.status(200).send(players)\r\n            } else {\r\n              throw {\r\n                name: 'NoPlayersExist',\r\n                message: 'There were no players found in the database for this query!'\r\n              }\r\n            }\r\n          })\r\n        } catch (error) {\r\n          this.logger.error(error)\r\n          res.status(400).send(error)\r\n        }\r\n      } else {\r\n        this.logger.error('Joi validation error: ' + validation.error)\r\n        res.status(400).send(validation.error)\r\n      }\r\n    } else {\r\n      //we are searching for players by criteria\r\n      const searchValidation = Joi.validate(req.query, PlayerSchema.listSearchParams)\r\n      if (searchValidation.error === null) {\r\n        try {\r\n          await this.players.where(req.query.queryProp, '==', req.query.queryVal).get().then((snapshot) => {\r\n            let players = []\r\n            snapshot.forEach((doc) => {\r\n              players.push(doc.data())\r\n            })\r\n            if (players.length > -1) {\r\n              res.status(200).send(players)\r\n            } else {\r\n              throw {\r\n                name: 'NoPlayersExist',\r\n                message: 'There were no players found in the database for this query!'\r\n              }\r\n            }\r\n          })\r\n        } catch (error) {\r\n          this.logger.error(error)\r\n          res.status(400).send(error)\r\n        }\r\n      } else {\r\n        this.logger.error('Joi validation error: ' + validation.error)\r\n        res.status(400).send(validation.error)\r\n      }\r\n    }\r\n  }\r\n\r\n  async update(req, res) {\r\n    const {id} = req.params\r\n    const validation = Joi.validate(req.query, PlayerSchema.updateParams)\r\n    if (validation.error === null) {\r\n      try {\r\n        const updateSet = {\r\n          regimen: JSON.parse(req.query.regimen)\r\n        }\r\n        await this.players.doc(id).update(updateSet).then(async (doc) => {\r\n          if (doc._writeTime) {\r\n            await this.players.doc(id).get().then((doc2) => {\r\n              res.status(200).send(doc2.data())\r\n            })\r\n          } else {\r\n            const errorMessage = 'Failed to write update to player for training regimen.'\r\n            this.logger.error(errorMessage)\r\n            res.status(400).send(errorMessage)\r\n          }\r\n        })\r\n      } catch (error) {\r\n        this.logger.error(error)\r\n        res.status(400).send(error)\r\n      }\r\n    } else {\r\n      this.logger.error('Joi validation error: ' + validation.error)\r\n      res.status(400).send(validation.error)\r\n    }\r\n  }\r\n\r\n  async listOne(req, res) {\r\n    const validation = Joi.validate(req.params, PlayerSchema.listOneParams)\r\n    if (validation.error === null) {\r\n      try {\r\n        await this.players.doc(req.params.id).get().then(async(doc) => {\r\n          let playerData = doc.data()\r\n          playerData.teamData = {}\r\n          playerData.contractData = {}\r\n          playerData.records = []\r\n          if (playerData.teamUid && playerData.teamUid.length > 0) {\r\n            await this.teams.doc(playerData.teamUid).get().then((doc2) => {\r\n              playerData.teamData = doc2.data()\r\n            })\r\n          }\r\n          if (playerData.contractUid && playerData.contractUid.length > 0) {\r\n            await this.contracts.doc(playerData.contractUid).get().then((doc3) => {\r\n              playerData.contractData = doc3.data()\r\n            })\r\n          }\r\n          await this.events.where('actorUid', '==', playerData.shockballPlayerUid).get().then((snapshot) => {\r\n            let events = []\r\n            snapshot.forEach((doc4) => {\r\n              events.push(doc4.data())\r\n            })\r\n            if (events.length > 0) {\r\n              playerData.records = util.generateSummaryRecords(events)\r\n            } else {\r\n              playerData.records = [{\r\n                season: '1',\r\n                matches: 0,\r\n                goals: 0,\r\n                shots: 0,\r\n                passes: 0,\r\n                blocksPass: 0,\r\n                blocksShot: 0,\r\n                tackles: 0,\r\n                runsBall: 0,\r\n                goalAverage: 0\r\n              }]\r\n            }\r\n          })\r\n          res.status(200).send(playerData)\r\n        })\r\n      } catch (error) {\r\n        this.logger.error(error)\r\n        res.status(400).send(error)\r\n      }\r\n    } else {\r\n      this.logger.error('Joi validation error: ' + validation.error)\r\n      res.status(400).send(validation.error)\r\n    }\r\n  }\r\n}\r\n\r\nexport default PlayerController"]}